---
title: "MBVagTrans Results"
author: "Simon Reider"
format: 
  html:
    code-fold: true
    toc: true
  pdf:
    toc: true
    number-sections: true
    colorlinks: true
editor: source
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = TRUE, message = FALSE)
library(knitr)
library(tidyverse)
library(phyloseq)
library(rstatix)
library(cowplot)
library(vegan)
library(pairwiseAdonis)
library(ggpubr)
theme_set(theme_bw())
```

# Introduction

Include here metadata summaries and summary of phyloseq object

# PBS empty control

The PBS empty control seems to be contaminated with normal vaginal flora.

```{r pbs}
taxdistri = read_csv2( "results/microbiome/pbs_taxonomic_composition.csv")
kable(mutate(taxdistri, Abundance = round(Abundance, digits = 2)))
```

![Taxonomic composition of PBS sample](results/microbiome/pbs_taxonomic_composition_piechart.png)

```{r get phyloseq object}
ps_samples = readRDS("intermediate/ps_samples.rds")
```

# Diversity Analysis

## Alpha-diversity

Alpha diversity describes the number and distribution of taxa *within* a sample or group of samples. Different indices exist that capture and describe different aspects of this ecologic measure.

In this dataset, alpha diversity is markedly different between the group of interest (i.e. *03_trans*) and the two control groups. However, the intervention group is more similar to the first control group (i.e. *postmenopausal women*).

```{r alpha diversity}
adiv = plot_richness(ps_samples, x = "grp", measures = c("Observed", "InvSimpson", "Shannon"))

aov = adiv$data %>%
  group_by(variable) %>%
  rstatix::anova_test(value~grp)

tukey = adiv$data %>%
  group_by(variable) %>%
  tukey_hsd(value~grp)

adiv +
  geom_boxplot(aes(fill = grp),alpha = 0.7) +
  labs(x = "", fill = "Group")+
  expand_limits(y = 0) 

kable(select(tukey, variable, group1,group2,p.adj, p.adj.signif))
```

### Effect of covariates

To rule out a possible effect of age on alpha diversity, pearson correlation of alpha diversity measures with age are performed within each of the 3 groups separately.

```{r adiv age}
adiv$data %>%
  group_by(variable, grp) %>%
  cor_test(value, Age) %>%
  select(grp, variable, cor, statistic, p, conf.low, conf.high) %>%
  kable()
```

No comparison is significant.

#### Length of GHAT within patient group

```{r adiv ghat}
adiv$data %>%
  filter(grp =="03_trans") %>%
  group_by(variable,grp) %>%
  cor_test(value, GHAT_Length) %>%
  select(grp, variable, cor, statistic, p, conf.low, conf.high) %>%
  kable()
```

In this analysis, a significant effect on Shannon index with length of GHAT could be observed.

#### Influence of Nugent score within patient group

```{r adiv nugent}
adiv$data %>%
  group_by(variable) %>%
  tukey_hsd(value~NugentScore) %>%
  select(variable, group1, group2, estimate, p.adj, p.adj.signif, conf.low, conf.high) %>%
  kable()
```

Notably, if analysis is split by patient group, none of these differences remain significant. This might be due to a lower sample size.

## Beta-diversity

This diversity metric compares different samples or groups of samples regarding their similarity or difference in community composition. The distance matrix can be visualized using dimension reduction techniques (e.g. PCA) or pairwise distances can be calculated. For this analysis, the main hypothesis is, that overall community composition differs significantly between the patien group (i.e. *03_trans*) and the two control groups. This will be tested using *adonis.*

```{r betadiversity}
# first, filter out low abundance taxa
lowabund_filter = genefilter_sample(ps_samples, filterfun_sample(function(x) x > 10), A=0.1*nsamples(ps_samples))
ps_filtered = prune_taxa(lowabund_filter, ps_samples)
ps_filtered

ps_filtered_rel = transform_sample_counts(ps_filtered, function(x) 100 * x/sum(x))

ord.bray<- ordinate(ps_filtered_rel, "PCoA", "bray")
ord.wunifrac <- ordinate(ps_filtered_rel, "PCoA", "unifrac", weighted = T)
ord.unifrac <- ordinate(ps_filtered_rel, "PCoA", "unifrac", weighted = F)

p1 = plot_ordination(ps_filtered_rel, ord.bray, type="samples", color="grp") +
  geom_point(size = 3, alpha = 0.8) +
  scale_color_brewer(type = "qual",palette = "Dark2") +
  stat_ellipse() +
  labs(color = "Group", caption = "Bray-Curtis")

p2 = plot_ordination(ps_filtered_rel, ord.wunifrac, type="samples", color="grp") +
  geom_point(size = 3, alpha = 0.8) +
  scale_color_brewer(type = "qual",palette = "Dark2") +
  stat_ellipse() +
  labs(color = "Group", caption = "Weighted Unifrac")

p3 = plot_ordination(ps_filtered_rel, ord.unifrac, type="samples", color="grp") +
  geom_point(size = 3, alpha = 0.8) +
  scale_color_brewer(type = "qual",palette = "Dark2")+
  stat_ellipse() +
  labs(color = "Group", caption = "Unweighted Unifrac")

# extract the legend from one of the plots
legend_b <- get_legend(
  p1 + 
    guides(color = guide_legend(nrow = 1)) +
    theme(legend.position = "bottom")
)

plot_ordinations = cowplot::plot_grid(p1 + theme(legend.position="none"),
                   p2 + theme(legend.position="none"),
                   p3 + theme(legend.position="none"),
                   labels =  "AUTO", ncol = 2)
```

```{r export plot, fig.height=8, fig.width=9}
cowplot::plot_grid(plot_ordinations, legend_b, ncol = 1, rel_heights = c(1, .1))
```

```{r adonis bdiv}
D_BC <- phyloseq::distance(ps_filtered_rel, "bray")
D_UF <- phyloseq::distance(ps_filtered_rel,  "unifrac")
D_wUF <- phyloseq::distance(ps_filtered_rel, "wunifrac")

adonis_bc = vegan::adonis2(D_BC ~ phyloseq::sample_data(ps_filtered_rel)$grp)
adonis_pw_bc = pairwise.adonis(D_BC, phyloseq::sample_data(ps_filtered_rel)$grp)

adonis_uf = vegan::adonis2(D_UF ~ phyloseq::sample_data(ps_filtered_rel)$grp)
adonis_pw_uf = pairwise.adonis(D_UF, phyloseq::sample_data(ps_filtered_rel)$grp)

adonis_wUF = vegan::adonis2(D_wUF ~ phyloseq::sample_data(ps_filtered_rel)$grp)
adonis_pw_wUF = pairwise.adonis(D_wUF, phyloseq::sample_data(ps_filtered_rel)$grp)

kable(adonis_pw_bc, caption = "Bray-Curtis")
kable(adonis_pw_uf, caption ="Unweigthed Unifrac")
kable(adonis_pw_wUF, caption = "Weighted Unifrac")
```

# Differential abundance

```{r deseq2}
library(DESeq2)

dds = phyloseq_to_deseq2(ps_filtered, ~ grp)
dds$grp<-relevel(dds$grp,ref="03_trans")
ds <- estimateSizeFactors(dds, type="poscounts")
ds = DESeq(ds, test="Wald", fitType="parametric")
alpha = 0.05 
res_premenopausal = results(ds, contrast = c("grp", "02_premenopausal", "03_trans"))
taxa_sig_premenopausal = dplyr::filter(as.data.frame(res_premenopausal), padj < 0.05) %>%
  rownames_to_column("ASV")

taxa_table = tax_table(ps_filtered) %>%
  as.data.frame() %>%
  rownames_to_column("ASV")

diffabund_pre = left_join(taxa_sig_premenopausal, taxa_table, by = "ASV") %>%
  select(-Species) %>%
  write_csv2("results/microbiome/deseq_diff_trans-premenopausal.csv")

kable(diffabund_pre, digits = 3, row.names = F, caption = "Differential abundance between premenopausal women and trans patients (pre vs trans)")

# repeat analysis for postmenopausal group
res_postmenopausal = results(ds, contrast = c("grp", "01_postmenopausal", "03_trans"))
taxa_sig_postmenopausal = dplyr::filter(as.data.frame(res_postmenopausal), padj < 0.05) %>%
  rownames_to_column("ASV")

diffabund_post = left_join(taxa_sig_postmenopausal, taxa_table, by = "ASV") %>%
  write_csv2("results/microbiome/deseq_diff_trans-postmenopausal.csv")

kable(diffabund_post, digits = 3, row.names = F, caption = "Differential abundance between postmenopausal women and trans patients (post vs trans)")

```

```{r plot deseq2 taxa}
asvs = unique(c(diffabund_pre$ASV, diffabund_post$ASV)) # get asvs identified by Deseq2

# next, melt the phyloseq object into a data.frame and filter OTUs for significant ASVs as identified by DESEQ2
ps_sig_melt = psmelt(ps_filtered_rel) %>%
  filter(OTU %in% asvs)

# Summarize Abundance at the genus level for plotting, almost no species are assigned in this dataset
ps_sig_melt2 = ps_sig_melt %>%
  group_by(Sample, Genus, grp) %>%
  summarize(Abundance = sum(Abundance))

# Plot the final figure panel
deseq_res_fig = ggplot(ps_sig_melt2, aes(x = grp, y=Abundance)) + 
  geom_jitter(width = 0.3, alpha = 0.6) +
  geom_boxplot(aes(fill = grp), alpha = 0.5, outlier.shape = NA) +
  facet_wrap(~Genus, scales = "free", ncol = 3) +
  scale_y_sqrt() +
  theme(axis.text.x=element_blank(),
      axis.ticks.x=element_blank()) +
  labs(x = "", fill = "Group", y= "Abundance (%)") +
  theme(legend.position = "bottom") +
    expand_limits(y = 0) 


# summary statistics
summarystat1 = ps_sig_melt2 %>%
  group_by(Genus, grp) %>%
  summarize(mean = mean(Abundance, na.rm=T),
            median = median(Abundance, na.rm =T),
            sd = sd(Abundance, na.rm = T),
            min = min(Abundance, na.rm =T),
            max = max(Abundance, na.rm =T))

write_csv2(x = summarystat1, "results/microbiome/deseq_summarystat_complete.csv")

summarystat2 = ps_sig_melt2 %>%
  group_by(Genus, grp) %>%
  summarize(mean = mean(Abundance, na.rm=T) %>% round(digits = 2),
            sd = sd(Abundance, na.rm = T) %>% round(digits = 2)) %>%
  mutate(stat = paste(mean, "Â±", sd)) %>%
  select(Genus, grp, stat) %>%
  pivot_wider(id_cols = "Genus", names_from = grp, values_from = stat)

write_csv2(summarystat2, "results/microbiome/deseq_summarystat_complete.csv")

kable(summarystat1)
kable(summarystat2)
```

This analysis reveals, that the *Trans* group is characterized by a loss of *Lactobacillus* and an increase in bacteria more commonly associated with the intestinal flora (e.g. *Campylobacter, Anaerococcus, Dialister, Prevotella)* compared to the premenopausal group.

Comparing the *Trans* to the *postmenopausal* group only revealed an even larger reduction in *Lactobacillus*.

Thus, overall the *trans* group is strinkingly similar in its taxonomic composition compared to postmenopausal women.

```{r plot deseq2, fig.width=9, fig.height=12}
deseq_res_fig
ggsave(deseq_res_fig, width = 7, height = 10, filename = "results/microbiome/deseq_asv_figure.pdf")
ggsave(deseq_res_fig, width = 7, height = 8, filename = "results/microbiome/deseq_asv_figure.png")
```

# Taxonomic composition

The following plots illustrate taxonomic composition at all levels of the taxonomy, The taxon table is filtered to only differentiate the most abundant taxa at each level (depending on the level).

```{r tax abundance plot}
ps.ns = prune_taxa(taxa_sums(ps_samples) >1, ps_samples) # remove singleton ASVs
ps_rel = transform_sample_counts(ps.ns, function(x) x/sum(x) *100) # transform to rel counts

# Generate agglomerated phyloseq objects
genus_rel = tax_glom(ps_rel, taxrank="Genus", NArm = F)
genus_rel # 383 genera
genus = psmelt(genus_rel) %>%
  mutate(Taxonomy = paste0("p_", Phylum, ";c_", Class, ";o_", Order, ";f_", Family, ";g_", Genus)) %>%
  select(Sample, Taxonomy, grp, Age:Estradiole, Abundance)
genus$Taxonomy[genus$Abundance < 10] <- "< 10 % abund."
  
genusplot = ggplot(genus, aes(x = grp, y = Abundance/25, fill = Taxonomy)) + 
  geom_col(position = "stack") +
  theme(legend.position = "right") +
  labs(y = "Abundance (%)", x= "", caption = "taxonomic level: genus") +
  rotate_x_text()

# Family Level
family_rel = tax_glom(ps_rel, taxrank="Family", NArm = F)
family_rel # 383 genera
family = psmelt(family_rel) %>%
  mutate(Taxonomy = paste0("p_", Phylum, ";c_", Class, ";o_", Order, ";f_", Family)) %>%
  select(Sample, Taxonomy, grp, Age:Estradiole, Abundance)
family$Taxonomy[family$Abundance < 15] <- "< 15 % abund."
  
familyplot = ggplot(family, aes(x = grp, y = Abundance/25, fill = Taxonomy)) + 
  geom_col(position = "stack") +
  theme(legend.position = "right") +
  labs(y = "Abundance (%)", x= "", caption = "taxonomic level: family") +
  rotate_x_text()

# Order Level
order_rel = tax_glom(ps_rel, taxrank="Order", NArm = F)
order_rel # 75 taxa
order = psmelt(order_rel) %>%
  mutate(Taxonomy = paste0("p_", Phylum, ";c_", Class, ";o_", Order)) %>%
  select(Sample, Taxonomy, grp, Age:Estradiole, Abundance)
order$Taxonomy[order$Abundance < 20] <- "< 20 % abund."
  
orderplot = ggplot(order, aes(x = grp, y = Abundance/25, fill = Taxonomy)) + 
  geom_col(position = "stack") +
  theme(legend.position = "right") +
  labs(y = "Abundance (%)", x= "", caption = "taxonomic level: order") +
  rotate_x_text()

# Class Level
class_rel = tax_glom(ps_rel, taxrank="Class", NArm = F)
class_rel # 30 taxa
class = psmelt(class_rel) %>%
  mutate(Taxonomy = paste0("p_", Phylum, ";c_", Class)) %>%
  select(Sample, Taxonomy, grp, Age:Estradiole, Abundance)
class$Taxonomy[class$Abundance < 25] <- "< 25 % abund."
  
classplot = ggplot(class, aes(x = grp, y = Abundance/25, fill = Taxonomy)) + 
  geom_col(position = "stack") +
  theme(legend.position = "right") +
  labs(y = "Abundance (%)", x= "", caption = "taxonomic level: class") +
  rotate_x_text()

# Phylum Level
phylum_rel = tax_glom(ps_rel, taxrank="Phylum", NArm = F)
phylum_rel # 18 taxa
phylum = psmelt(phylum_rel) %>%
  mutate(Taxonomy = paste0("p_", Phylum)) %>%
  select(Sample, Taxonomy, grp, Age:Estradiole, Abundance)
phylum$Taxonomy[phylum$Abundance < 25] <- "< 25 % abund."
  
phylumplot = ggplot(phylum, aes(x = grp, y = Abundance/25, fill = Taxonomy)) + 
  geom_col(position = "stack") +
  theme(legend.position = "right") +
  labs(y = "Abundance (%)", x= "", caption = "taxonomic level: phylum") +
  rotate_x_text()

```

## Phylum level

On the phylum level, the taxonomic distribution is dominated by *Firmicutes* (these correspond to *Lactobacilli*, see below). The *Trans* group also shows an increase in *Bacteroidota* compared to the other 2 groups.

```{r phylum plot, fig.width=4, height = 5}
phylumplot
ggsave(plot = phylumplot, filename = "results/microbiome/taxplots_phylum.pdf", width = 4, height = 5)
```

## Class level

```{r class plot, fig.width=6, height = 5}
classplot
ggsave(plot = classplot, filename = "results/microbiome/taxplots_class.pdf", width = 6, height = 5)
ggsave(plot = classplot, filename = "results/microbiome/taxplots_class.png", width = 6, height = 5)

```

## Order level

```{r order plot, fig.width=7, height = 5}
orderplot
ggsave(plot = orderplot, filename = "results/microbiome/taxplots_order.pdf", width = 7, height = 5)
ggsave(plot = orderplot, filename = "results/microbiome/taxplots_order.png", width = 7, height = 5)

```

## Family level

```{r family plot, fig.width=8, height = 6}
familyplot
ggsave(plot = familyplot, filename = "results/microbiome/taxplots_family.pdf", width = 8, height = 6)
ggsave(plot = familyplot, filename = "results/microbiome/taxplots_family.png", width = 8, height = 6)

```

## Genus level



```{r genus plot, fig.width=15, height = 6}
genusplot
ggsave(plot = genusplot, filename = "results/microbiome/taxplots_genus.pdf", width = 15, height = 6)
ggsave(plot = genusplot, filename = "results/microbiome/taxplots_family.png", width = 15, height = 6)

```
